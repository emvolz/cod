<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>N. gonorrhea: Computing coalescent odds, identifying growing lineages, cluster identification &amp; sample reweighting • cod</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="N. gonorrhea: Computing coalescent odds, identifying growing lineages, cluster identification &amp; sample reweighting">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cod</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/ngono.html">N. gonorrhea: Computing coalescent odds, identifying growing lineages, cluster identification &amp; sample reweighting</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>N. gonorrhea: Computing coalescent odds, identifying growing lineages, cluster identification &amp; sample reweighting</h1>
                        <h4 data-toc-skip class="author">Erik Volz</h4>
            
            <h4 data-toc-skip class="date">2025-09-24</h4>
      

      <div class="d-none name"><code>ngono.Rmd</code></div>
    </div>

    
    
<p>This vignette demonstrates the main functions of <code>cod</code>
using data from 1,102 Neiseria gonorrhoeae genomes first described in <a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Grad Y.H. , Harris S.R., Kirkcaldy R.D., Green A.G.,
Marks D.S., Bentley S.D., Trees D., Lipsitch M. 2016. Genomic
epidemiology of gonococcal resistance to extended-spectrum
cephalosporins, macrolides, and fluoroquinolones in the United States,
2000-2013. J. Infect. Dis. 214:1579-1587.&lt;/p&gt;"><sup>1</sup></a>. The data
used here were further analysed in <a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Erik M Volz, Wiuf Carsten, Yonatan H Grad, Simon D W
Frost, Ann M Dennis, Xavier Didelot, Identification of Hidden Population
Structure in Time-Scaled Phylogenies, Systematic Biology, Volume 69,
Issue 5, September 2020, Pages 884–896, &lt;a href="https://doi.org/10.1093/sysbio/syaa009" class="external-link uri"&gt;https://doi.org/10.1093/sysbio/syaa009&lt;/a&gt;&lt;/p&gt;'><sup>2</sup></a> and this version of the data are available
at <a href="https://github.com/xavierdidelot/gonophylo" class="external-link">https://github.com/xavierdidelot/gonophylo</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://emvolz.github.io/cod/">cod</a></span><span class="op">)</span></span>
<span><span class="va">tr</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/read.tree.html" class="external-link">read.tree</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata/grad2016-treedater-tr1.nwk'</span>, package<span class="op">=</span><span class="st">'cod'</span> <span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">md</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span> <span class="st">'extdata/grad2016-a2md.csv'</span> , package<span class="op">=</span><span class="st">'cod'</span> <span class="op">)</span> <span class="op">)</span> </span></code></pre></div>
<p>This is a time-scaled phylogeny estimated with the
<code>treedater</code> R package.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tr</span> </span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Phylogenetic tree with 1102 tips and 1101 internal nodes.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Tip labels:</span></span>
<span><span class="co">##   17176_1#21, 15335_3#33, 15335_6#51, 15335_4#63, 15335_5#50, 8727_8#36, ...</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Rooted; includes branch length(s).</span></span></code></pre>
<p>Metadata includes the year of sample collection, clinic where the
sample was collected, and resistance scores to several classes of
antibiotics. For the purposes of this vignette, we will consider a score
of “2” to represent resistance.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">md</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           ID PEN TET SPC CFX CRO CIP AZI Clinic Year</span></span>
<span><span class="co">## 1  15335_2#1   2   2   0   2   0   2   1    POR 2012</span></span>
<span><span class="co">## 2 15335_2#10   1   1   0   0   0   0   2    MIN 2005</span></span>
<span><span class="co">## 3 15335_2#11   1   1   0   0   0   0   2    MIN 2005</span></span>
<span><span class="co">## 4 15335_2#12   1   2   0   0   0   0   2    LVG 2006</span></span>
<span><span class="co">## 5 15335_2#13   2   2   0  NA   0   2   2    CHI 2008</span></span>
<span><span class="co">## 6 15335_2#14   2   2   0  NA   0   0   2    KCY 2008</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span> <span class="va">md</span><span class="op">$</span><span class="va">Year</span>, title <span class="op">=</span> <span class="st">''</span>, ylabel <span class="op">=</span> <span class="st">''</span>, xlabel <span class="op">=</span> <span class="st">'Year'</span> <span class="op">)</span></span></code></pre></div>
<p><img src="ngono_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<div class="section level2">
<h2 id="estimating-coalescent-odds">Estimating coalescent odds<a class="anchor" aria-label="anchor" href="#estimating-coalescent-odds"></a>
</h2>
<p>The main function to estimate coalescent odds using weighted least
squares is <code>codls</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/codls.html">codls</a></span><span class="op">(</span> <span class="va">tr</span> <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    logtau      loss optimal</span></span>
<span><span class="co">## 1    -4.0 200516.48        </span></span>
<span><span class="co">## 2     0.1  87477.40        </span></span>
<span><span class="co">## 3     4.2  86547.03     ***</span></span>
<span><span class="co">## 4     8.3  86589.56        </span></span>
<span><span class="co">## 5    12.4       Inf        </span></span>
<span><span class="co">## 6    16.5       Inf        </span></span>
<span><span class="co">## 7    20.6       Inf        </span></span>
<span><span class="co">## 8    24.7       Inf        </span></span>
<span><span class="co">## 9    28.8       Inf        </span></span>
<span><span class="co">## 10   32.9       Inf        </span></span>
<span><span class="co">## 11   37.0       Inf</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span></span></code></pre></div>
<pre><code><span><span class="co">##  Genealogical placement GMRF model fit </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Phylogenetic tree with 1102 tips and 1101 internal nodes.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Tip labels:</span></span>
<span><span class="co">##   17176_1#21, 15335_3#33, 15335_6#51, 15335_4#63, 15335_5#50, 8727_8#36, ...</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Rooted; includes branch length(s).</span></span>
<span><span class="co">## Range of coefficients: </span></span>
<span><span class="co">## -0.442259845161674 0.426205484263409</span></span>
<span><span class="co">## Precision parameter (log tau): 4.2</span></span></code></pre>
<p>The only required argument is a time-scaled phylogenetic tree. This
method models the correlation of coalescent odds between phylogenetic
lineages using a Gaussian-Markov Random Field which includes a precision
parameter <code>logtau</code>. If indepently estimated, this can be
provided to <code>codls</code> to speed up estimation, but if omitted,
<code>logtau</code> will be automatically estimated using the
<code>tauprofile</code> function. You can also speed up
<code>codls</code> by using multiple CPUs with the <code>ncpu</code>
argument.</p>
<p>Plotting the fit will display a tree with estimated log odds of
coalescence mapped by colour on to branches. Note that this requires the
<code>ggtree</code> package to be installed.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot the tree with coalescent odds - handle potential ggtree issues</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span><span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Plot generation failed due to ggtree compatibility issue:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">e</span><span class="op">$</span><span class="va">message</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Tree summary:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nCoalescent odds summary:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p><img src="ngono_files/figure-html/unnamed-chunk-5-1.png" width="1056"></p>
<p>The coalescent odds for each branch can be retrieved using
<code>coef</code>, e.g.:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span> </span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.003407523 0.005130719 0.005719041 0.006293182</span></span></code></pre>
<p>These are in the same order as nodes in the input tree.</p>
<p>Let’s merge the estimated coalescent odds back into the metadata for
subsequent analysis:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span> tip <span class="op">=</span> <span class="va">f</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">tip.label</span>, psi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/summary.phylo.html" class="external-link">Ntip</a></span><span class="op">(</span><span class="va">tr</span><span class="op">)</span><span class="op">]</span> <span class="op">)</span></span>
<span><span class="va">md</span><span class="op">$</span><span class="va">tip</span>  <span class="op">&lt;-</span> <span class="va">md</span><span class="op">$</span><span class="va">ID</span> </span>
<span><span class="va">md</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span> <span class="va">md</span>, <span class="va">fdf</span>, by <span class="op">=</span> <span class="st">'tip'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span> <span class="va">md</span> <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##          tip         ID PEN TET SPC CFX CRO CIP AZI Clinic Year         psi</span></span>
<span><span class="co">## 1  15335_2#1  15335_2#1   2   2   0   2   0   2   1    POR 2012 -0.04803569</span></span>
<span><span class="co">## 2 15335_2#10 15335_2#10   1   1   0   0   0   0   2    MIN 2005  0.24893462</span></span>
<span><span class="co">## 3 15335_2#11 15335_2#11   1   1   0   0   0   0   2    MIN 2005  0.24848434</span></span>
<span><span class="co">## 4 15335_2#12 15335_2#12   1   2   0   0   0   0   2    LVG 2006  0.24821303</span></span>
<span><span class="co">## 5 15335_2#13 15335_2#13   2   2   0  NA   0   2   2    CHI 2008 -0.02901797</span></span>
<span><span class="co">## 6 15335_2#14 15335_2#14   2   2   0  NA   0   0   2    KCY 2008 -0.04413655</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="sample-weights">Sample weights<a class="anchor" aria-label="anchor" href="#sample-weights"></a>
</h2>
<p>If we examine the relationship between coalescent odds and where
samples originated (Clinic) there are a few clinics with significantly
higher values:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span> <span class="va">md</span><span class="op">$</span><span class="va">Clinic</span> <span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="op">)</span> </span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## COL LA2 SLC STL FBG GRB IND PON NOR LBC NYC CLE RIC KCY ALB DTR OKC DAL CIN ATL </span></span>
<span><span class="co">##   3   3   3   3   4   6   6   6   7   8   8  11  11  13  14  14  14  16  22  25 </span></span>
<span><span class="co">## BHM MIA SEA DEN BAL HON POR MIN LAX ORA PHX SFO PHI CHI LVG SDG </span></span>
<span><span class="co">##  28  28  29  30  33  35  48  51  53  62  64  67  69  71  85 152</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span> <span class="va">psi</span> <span class="op">~</span> <span class="va">Clinic</span>, data <span class="op">=</span> <span class="va">md</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span> </span>
<span><span class="va">s</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## lm(formula = psi ~ Clinic, data = md)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Residuals:</span></span>
<span><span class="co">##      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">## -0.50273 -0.08555 -0.03763  0.02845  0.56277 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Coefficients:</span></span>
<span><span class="co">##               Estimate Std. Error t value Pr(&gt;|t|)  </span></span>
<span><span class="co">## (Intercept)  0.0052379  0.0480984   0.109   0.9133  </span></span>
<span><span class="co">## ClinicATL    0.0037715  0.0600749   0.063   0.9500  </span></span>
<span><span class="co">## ClinicBAL   -0.0297057  0.0574015  -0.518   0.6049  </span></span>
<span><span class="co">## ClinicBHM   -0.0842535  0.0589083  -1.430   0.1529  </span></span>
<span><span class="co">## ClinicCHI    0.0139142  0.0526273   0.264   0.7915  </span></span>
<span><span class="co">## ClinicCIN   -0.0352066  0.0615277  -0.572   0.5673  </span></span>
<span><span class="co">## ClinicCLE   -0.1300334  0.0725111  -1.793   0.0732 .</span></span>
<span><span class="co">## ClinicCOL   -0.1405248  0.1144972  -1.227   0.2200  </span></span>
<span><span class="co">## ClinicDAL    0.0690866  0.0658615   1.049   0.2944  </span></span>
<span><span class="co">## ClinicDEN    0.0412778  0.0582501   0.709   0.4787  </span></span>
<span><span class="co">## ClinicDTR   -0.0856221  0.0680215  -1.259   0.2084  </span></span>
<span><span class="co">## ClinicFBG   -0.1115689  0.1020322  -1.093   0.2744  </span></span>
<span><span class="co">## ClinicGRB    0.1535391  0.0878153   1.748   0.0807 .</span></span>
<span><span class="co">## ClinicHON   -0.0043148  0.0569108  -0.076   0.9396  </span></span>
<span><span class="co">## ClinicIND   -0.0488006  0.0878153  -0.556   0.5785  </span></span>
<span><span class="co">## ClinicKCY    0.0552351  0.0693172   0.797   0.4257  </span></span>
<span><span class="co">## ClinicLA2    0.1110863  0.1144972   0.970   0.3322  </span></span>
<span><span class="co">## ClinicLAX    0.0161195  0.0540792   0.298   0.7657  </span></span>
<span><span class="co">## ClinicLBC   -0.0761099  0.0797622  -0.954   0.3402  </span></span>
<span><span class="co">## ClinicLVG   -0.0550232  0.0519086  -1.060   0.2894  </span></span>
<span><span class="co">## ClinicMIA    0.0763673  0.0589083   1.296   0.1951  </span></span>
<span><span class="co">## ClinicMIN   -0.0261175  0.0543003  -0.481   0.6306  </span></span>
<span><span class="co">## ClinicNOR   -0.1240360  0.0833089  -1.489   0.1368  </span></span>
<span><span class="co">## ClinicNYC   -0.0308319  0.0797622  -0.387   0.6992  </span></span>
<span><span class="co">## ClinicOKC   -0.1496981  0.0680215  -2.201   0.0280 *</span></span>
<span><span class="co">## ClinicORA    0.0320981  0.0532527   0.603   0.5468  </span></span>
<span><span class="co">## ClinicPHI   -0.0270736  0.0527528  -0.513   0.6079  </span></span>
<span><span class="co">## ClinicPHX    0.0520299  0.0530992   0.980   0.3274  </span></span>
<span><span class="co">## ClinicPON   -0.0770099  0.0878153  -0.877   0.3807  </span></span>
<span><span class="co">## ClinicPOR    0.0006079  0.0546646   0.011   0.9911  </span></span>
<span><span class="co">## ClinicRIC   -0.0593261  0.0725111  -0.818   0.4134  </span></span>
<span><span class="co">## ClinicSDG    0.0291153  0.0502647   0.579   0.5625  </span></span>
<span><span class="co">## ClinicSEA   -0.0522784  0.0585688  -0.893   0.3723  </span></span>
<span><span class="co">## ClinicSFO   -0.0039325  0.0528854  -0.074   0.9407  </span></span>
<span><span class="co">## ClinicSLC   -0.2952074  0.1144972  -2.578   0.0101 *</span></span>
<span><span class="co">## ClinicSTL   -0.2333512  0.1144972  -2.038   0.0418 *</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Residual standard error: 0.18 on 1066 degrees of freedom</span></span>
<span><span class="co">## Multiple R-squared:  0.07834,    Adjusted R-squared:  0.04808 </span></span>
<span><span class="co">## F-statistic: 2.589 on 35 and 1066 DF,  p-value: 1.699e-06</span></span></code></pre>
<p>It is possible that this occurred because these locations were
sampled more intensively than other clinics which can artificially
increase coalescent rates because of higher local density of
co-circulating lineages. Samples can be down-weighted in
<code>codls</code> by passing the <code>*weights*</code> argument, which
should ameliorate bias from over-sampling if we know how much
over-sampling took place. Unfortunately, this is rarely known, so
<code>cod</code> includes a routine to consider a range of sample
weights and will identify the maximum weight such that there is no
longer a significant relationship between coalescent odds and a given
variable (usually geographic). Here we identify all samples from the
“MIA” clinical and pass these to the <code>autoreweight</code>
function.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Clinics associated with psi :</span></span>
<span><span class="va">signifclinics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">coefficients</span><span class="op">)</span><span class="op">[</span> <span class="va">s</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span> , <span class="fl">4</span><span class="op">]</span>  <span class="op">&lt;</span> <span class="fl">.1</span> <span class="op">]</span></span>
<span><span class="va">signifclinics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">signifclinics</span>, <span class="fl">7</span>,<span class="fl">9</span> <span class="op">)</span></span>
<span><span class="co"># Subset of tips from clinics associated with psi :</span></span>
<span><span class="va">reweighttips</span>  <span class="op">&lt;-</span> <span class="va">md</span><span class="op">$</span><span class="va">tip</span><span class="op">[</span> <span class="va">md</span><span class="op">$</span><span class="va">Clinic</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">signifclinics</span> <span class="op">]</span></span>
<span><span class="va">arw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/autoreweight.html">autoreweight</a></span><span class="op">(</span> <span class="va">f</span>, <span class="va">reweighttips</span>, wlb <span class="op">=</span> <span class="fl">1e-2</span>, wub <span class="op">=</span> <span class="fl">.5</span>, res <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">.02</span> <span class="op">)</span></span>
<span><span class="va">f</span> <span class="op">=</span> <span class="va">arw</span><span class="op">$</span><span class="va">fit</span></span>
<span><span class="va">arw</span><span class="op">$</span><span class="va">summary</span></span></code></pre></div>
<pre><code><span><span class="co">##   sampleweight            p</span></span>
<span><span class="co">## 1       0.0100 1.554659e-05</span></span>
<span><span class="co">## 2       0.1325 2.257137e-05</span></span>
<span><span class="co">## 3       0.2550 3.269453e-05</span></span>
<span><span class="co">## 4       0.3775 4.723516e-05</span></span>
<span><span class="co">## 5       0.5000 6.804639e-05</span></span></code></pre>
<p>Note that in some cases, the association will not disappear even if
the weight is zero because lineages surrounding the given samples also
have higher coalescent odds. In these cases, the relationship is more
likely to be authentic. That is exactly what we see here. Even when
weighting these samples at 1% (unrealistically low) there remains a
significant association with coalescent odds. Consequently, this fit
will be identical to the original fit.</p>
</div>
<div class="section level2">
<h2 id="antibiotic-resistance">Antibiotic resistance<a class="anchor" aria-label="anchor" href="#antibiotic-resistance"></a>
</h2>
<p>Here we examine the relationship between coalescent odds and
antibiotic resistance. First, we replot the coloured tree alongside
resistance phenotypes.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">abxs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="st">'PEN'</span>, <span class="st">'TET'</span>, <span class="st">'CFX'</span>, <span class="st">'CRO'</span>, <span class="st">'CIP'</span>, <span class="st">'AZI'</span><span class="op">)</span></span>
<span><span class="va">abxmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">md</span><span class="op">[</span>, <span class="va">abxs</span> <span class="op">]</span> <span class="op">)</span></span>
<span><span class="va">abxmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">abxmat</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="va">x</span> <span class="op">==</span> <span class="st">"2"</span><span class="op">)</span> <span class="op">)</span> <span class="co"># The value of '2' is coded as abx resistant</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span> <span class="va">abxmat</span> <span class="op">)</span> <span class="op">&lt;-</span> <span class="va">md</span><span class="op">$</span><span class="va">tip</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">abxmat</span><span class="op">)</span> </span></code></pre></div>
<pre><code><span><span class="co">##              PEN   TET   CFX   CRO   CIP   AZI</span></span>
<span><span class="co">## 15335_2#1   TRUE  TRUE  TRUE FALSE  TRUE FALSE</span></span>
<span><span class="co">## 15335_2#10 FALSE FALSE FALSE FALSE FALSE  TRUE</span></span>
<span><span class="co">## 15335_2#11 FALSE FALSE FALSE FALSE FALSE  TRUE</span></span>
<span><span class="co">## 15335_2#12 FALSE  TRUE FALSE FALSE FALSE  TRUE</span></span>
<span><span class="co">## 15335_2#13  TRUE  TRUE    NA FALSE  TRUE  TRUE</span></span>
<span><span class="co">## 15335_2#14  TRUE  TRUE    NA FALSE FALSE  TRUE</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">abxmat</span><span class="op">[</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">abxmat</span><span class="op">)</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span></span>
<span><span class="co"># Try to create tree plot with heatmap, handle ggtree issues</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">trpl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_color_gradient2</a></span><span class="op">(</span> low<span class="op">=</span><span class="st">'blue'</span></span>
<span>                                  , mid <span class="op">=</span> <span class="st">'lightblue'</span></span>
<span>                                  , high <span class="op">=</span> <span class="st">'red'</span></span>
<span>                                  , midpoint <span class="op">=</span> <span class="fl">0</span></span>
<span>                                  , limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">fdf</span><span class="op">$</span><span class="va">psi</span><span class="op">)</span></span>
<span>                                  , name <span class="op">=</span> <span class="st">"ψ"</span> <span class="op">)</span></span>
<span>  <span class="va">trpl</span> <span class="op">&lt;-</span> <span class="fu">ggtree</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggtree/man/gheatmap.html" class="external-link">gheatmap</a></span><span class="op">(</span> <span class="va">trpl</span>, <span class="va">abxmat</span>, colnames_position<span class="op">=</span><span class="st">'top'</span>, colnames_offset_y <span class="op">=</span> <span class="op">-</span><span class="fl">11</span><span class="op">)</span></span>
<span>  <span class="va">trpl</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">label</span> <span class="op">=</span> <span class="st">''</span> <span class="co"># suppress tip labels </span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">trpl</span><span class="op">)</span></span>
<span><span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Tree plot with heatmap failed due to ggtree compatibility issue:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">e</span><span class="op">$</span><span class="va">message</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nAntibiotic resistance summary:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">abxmat</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nSamples with highest coalescent odds:\n"</span><span class="op">)</span></span>
<span>  <span class="va">top_psi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">md</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">md</span><span class="op">$</span><span class="va">psi</span>, decreasing<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tip"</span>, <span class="st">"psi"</span>, <span class="va">abxs</span><span class="op">)</span><span class="op">]</span>, <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">top_psi</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Tree plot with heatmap failed due to ggtree compatibility issue:</span></span>
<span><span class="co">## &lt;ggtree&gt; object properties are invalid:</span></span>
<span><span class="co">## - @mapping must be &lt;ggplot2::mapping&gt;, not S3&lt;data.frame&gt; </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Antibiotic resistance summary:</span></span>
<span><span class="co">## PEN TET CFX CRO CIP AZI </span></span>
<span><span class="co">## 537 661 266   8 594 232 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Samples with highest coalescent odds:</span></span>
<span><span class="co">##            tip       psi PEN TET CFX CRO CIP AZI</span></span>
<span><span class="co">## 492 15335_7#38 0.4262055   1   2   0   0   0   2</span></span>
<span><span class="co">## 512 15335_7#57 0.4262055   1   2   0   0   0   2</span></span>
<span><span class="co">## 490 15335_7#36 0.4262054   1   2   0   0   0   2</span></span>
<span><span class="co">## 482 15335_7#29 0.4259646   1   2   0   0   0   2</span></span>
<span><span class="co">## 488 15335_7#34 0.4259645   1   2   0   0   0   2</span></span>
<span><span class="co">## 479 15335_7#26 0.4257999   1   2   0   0   0   2</span></span>
<span><span class="co">## 459 15335_6#93 0.4254206   1   0   0   0   0   1</span></span>
<span><span class="co">## 700 17176_1#28 0.4254206   1   0   0   0   0   1</span></span>
<span><span class="co">## 702  17176_1#3 0.4253203   1   0   0   0   0   1</span></span>
<span><span class="co">## 698 17176_1#26 0.4251364   1   0   0   0   0   1</span></span></code></pre>
<p>It looks like higher coalescent odds are associated with AZI
resistance and no other abx shows a positive effect. Let’s quantify
this. Here we do a linear regression of coalescent odds on each abx and
time, then infer the mean psi at the end of sampling (year 2013).</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">md</span><span class="op">$</span><span class="va">t</span>  <span class="op">&lt;-</span> <span class="va">md</span><span class="op">$</span><span class="va">Year</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">md</span><span class="op">$</span><span class="va">Year</span><span class="op">)</span></span>
<span><span class="va">psi2013</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span> <span class="va">abxs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>    <span class="va">md1</span> <span class="op">&lt;-</span> <span class="va">md</span></span>
<span>    <span class="va">md1</span><span class="op">$</span><span class="va">v</span> <span class="op">&lt;-</span> <span class="va">md1</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="fl">2</span></span>
<span>    <span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span> <span class="va">psi</span> <span class="op">~</span> <span class="va">v</span><span class="op">*</span><span class="va">t</span>  , data <span class="op">=</span> <span class="va">md1</span> <span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span> <span class="va">m</span>, newdata<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span> psi <span class="op">=</span> <span class="cn">NA</span>, v <span class="op">=</span> <span class="cn">TRUE</span>, t <span class="op">=</span> <span class="fl">13</span> <span class="op">)</span> , interval<span class="op">=</span><span class="st">'confidence'</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span> <span class="va">abxs</span> <span class="op">)</span></span>
<span><span class="va">ebdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span> <span class="va">psi2013</span> <span class="op">)</span> <span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">ebdf</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="st">'Median'</span>, <span class="st">'2.5%'</span>, <span class="st">'97.5%'</span> <span class="op">)</span></span>
<span><span class="va">ebdf</span><span class="op">$</span><span class="va">abx</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span> <span class="va">ebdf</span> <span class="op">)</span> </span>
<span><span class="va">ebdf</span> <span class="op">&lt;-</span> <span class="va">ebdf</span><span class="op">[</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span> <span class="va">ebdf</span><span class="op">$</span><span class="va">Median</span> <span class="op">)</span> , <span class="op">]</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span> <span class="va">ebdf</span> <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           Median        2.5%       97.5% abx</span></span>
<span><span class="co">## CRO -0.062852959 -0.28257319  0.15686727 CRO</span></span>
<span><span class="co">## PEN -0.042395359 -0.06566536 -0.01912536 PEN</span></span>
<span><span class="co">## CIP -0.041630966 -0.06456462 -0.01869732 CIP</span></span>
<span><span class="co">## CFX -0.005595061 -0.04700795  0.03581783 CFX</span></span>
<span><span class="co">## TET -0.003377564 -0.02501186  0.01825674 TET</span></span>
<span><span class="co">## AZI  0.247253178  0.21017410  0.28433226 AZI</span></span></code></pre>
<p>Here the result is plotted:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">peb</span> <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">ebdf</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">abx</span>, y <span class="op">=</span> <span class="va">Median</span>, ymin <span class="op">=</span> <span class="va">`2.5%`</span>, ymax <span class="op">=</span> <span class="va">`97.5%`</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span>width<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">'psi'</span>, x <span class="op">=</span> <span class="st">''</span> <span class="op">)</span></span>
<span><span class="va">peb</span></span></code></pre></div>
<p><img src="ngono_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p>In fact, resistance to AZI expanded rapidly after these data were
collected, from a prevalence of 0.6% in 2013 to 4.5% in 2017<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Centers for Disease Control and Prevention. (2018).
Sexually transmitted disease surveillance 2017. U.S. Department of
Health and Human Services.&lt;/p&gt;"><sup>3</sup></a>. This is
the most rapid growth among these antibiotics.</p>
</div>
<div class="section level2">
<h2 id="phylogenetic-clusters">Phylogenetic clusters<a class="anchor" aria-label="anchor" href="#phylogenetic-clusters"></a>
</h2>
<p>An alternative way to look at coalescent odds is in terms of
phylogenetic clusters. These are clades defined by a threshold change in
coalescent odds along a lineage, from low to high values. There is some
subjectivity in the choice of clustering thresholds and the best choice
depends on the application, however <code>cod</code> provides a method
based on the <a href="https://en.wikipedia.org/wiki/Calinski%E2%80%93Harabasz_index" class="external-link">Calinski-Harabasz
index</a>.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chindices.html">chindices</a></span><span class="op">(</span><span class="va">f</span>, clths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span> <span class="fl">.03</span>, <span class="fl">.4</span>, length <span class="op">=</span> <span class="fl">20</span> <span class="op">)</span>, rescale<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">chis</span></span></code></pre></div>
<pre><code><span><span class="co">##     threshold        CH optimal</span></span>
<span><span class="co">## 1  0.03000000 1502518.1        </span></span>
<span><span class="co">## 2  0.04947368  650599.0        </span></span>
<span><span class="co">## 3  0.06894737  807982.9        </span></span>
<span><span class="co">## 4  0.08842105  902511.2        </span></span>
<span><span class="co">## 5  0.10789474  946716.4        </span></span>
<span><span class="co">## 6  0.12736842 1334924.7        </span></span>
<span><span class="co">## 7  0.14684211 1532793.1        </span></span>
<span><span class="co">## 8  0.16631579 1641530.8     ***</span></span>
<span><span class="co">## 9  0.18578947  786818.6        </span></span>
<span><span class="co">## 10 0.20526316  950306.2        </span></span>
<span><span class="co">## 11 0.22473684  885988.9        </span></span>
<span><span class="co">## 12 0.24421053  885988.9        </span></span>
<span><span class="co">## 13 0.26368421 1215831.1        </span></span>
<span><span class="co">## 14 0.28315789 1215831.1        </span></span>
<span><span class="co">## 15 0.30263158 1215831.1        </span></span>
<span><span class="co">## 16 0.32210526 1215831.1        </span></span>
<span><span class="co">## 17 0.34157895 1215831.1        </span></span>
<span><span class="co">## 18 0.36105263 1215831.1        </span></span>
<span><span class="co">## 19 0.38052632 1215831.1        </span></span>
<span><span class="co">## 20 0.40000000 1215831.1</span></span></code></pre>
<p>Here, we compute clusters using the maximum CH index. Note that if no
threshold is provided, <code>computeclusters</code> will automatically
select the optimal threshold:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Using optimal threshold from CH index</span></span>
<span><span class="va">chdf</span> <span class="op">=</span> <span class="fu"><a href="../reference/computeclusters.html">computeclusters</a></span><span class="op">(</span><span class="va">f</span>, <span class="va">chis</span><span class="op">$</span><span class="va">threshold</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">chis</span><span class="op">$</span><span class="va">CH</span><span class="op">)</span><span class="op">]</span> <span class="op">)</span></span>
<span><span class="co"># Alternatively, let computeclusters automatically select optimal threshold:</span></span>
<span><span class="co"># chdf = computeclusters(f)  </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">chdf</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   node  tip.label clusterid        psi   tip</span></span>
<span><span class="co">## 1 1088 15335_5#48         1 -0.4209262  TRUE</span></span>
<span><span class="co">## 2 1089 15335_3#80         1 -0.4311232  TRUE</span></span>
<span><span class="co">## 3 1089 15335_3#80         1 -0.4311232  TRUE</span></span>
<span><span class="co">## 4 2191                    1 -0.3838401 FALSE</span></span>
<span><span class="co">## 5 1065 17176_1#39         2 -0.4356554  TRUE</span></span>
<span><span class="co">## 6 1066  8289_2#72         2 -0.4411569  TRUE</span></span></code></pre>
<p>Plotting these shows that one cluster very closely matches a clade
with high levels of AZI resistance and high coalescent odds, so an
alternative way to analyse these data would be to identify clusters with
high coalescent odds and then characterise resistance patters within
these clusters. The clusters can be visualised by running
<code>plotclusters(f, chdf)</code>.</p>
<div class="float">
<img src="ngonoclust.png" alt="Cluster visualization showing phylogenetic tree with heatmap of cluster assignments"><div class="figcaption">Cluster visualization showing phylogenetic tree
with heatmap of cluster assignments</div>
</div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Cluster summary statistics</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Cluster summary:\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Cluster summary:</span></span></code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">chdf</span><span class="op">$</span><span class="va">clusterid</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##   1   2   3   4   5   6   7   8   9  10  11  12  13  14 </span></span>
<span><span class="co">##   4  46 158 270 104  88 888 910 145   3  15 457   1  51</span></span></code></pre>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nCluster statistics (coalescent odds by cluster):\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Cluster statistics (coalescent odds by cluster):</span></span></code></pre>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cluster_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">chdf</span><span class="op">$</span><span class="va">psi</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">chdf</span><span class="op">$</span><span class="va">clusterid</span><span class="op">)</span>,</span>
<span>                           <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>mean<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                                       sd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">x</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                                       n<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">cluster_stats</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cluster"</span>, <span class="st">"psi_stats"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">cluster_stats</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    cluster psi_stats.mean  psi_stats.sd   psi_stats.n</span></span>
<span><span class="co">## 1        1   -0.416753158   0.022462421   4.000000000</span></span>
<span><span class="co">## 2        2   -0.416514088   0.019188764  46.000000000</span></span>
<span><span class="co">## 3        3   -0.239161430   0.039221155 158.000000000</span></span>
<span><span class="co">## 4        4   -0.071805631   0.012269594 270.000000000</span></span>
<span><span class="co">## 5        5   -0.017465734   0.018791471 104.000000000</span></span>
<span><span class="co">## 6        6   -0.013355858   0.010180204  88.000000000</span></span>
<span><span class="co">## 7        7    0.315540443   0.091935636 888.000000000</span></span>
<span><span class="co">## 8        8   -0.032857085   0.016487044 910.000000000</span></span>
<span><span class="co">## 9        9   -0.094540079   0.021518781 145.000000000</span></span>
<span><span class="co">## 10      10   -0.154503030   0.018780184   3.000000000</span></span>
<span><span class="co">## 11      11   -0.216450242   0.009101256  15.000000000</span></span>
<span><span class="co">## 12      12   -0.076401526   0.064003733 457.000000000</span></span>
<span><span class="co">## 13      13   -0.277591516            NA   1.000000000</span></span>
<span><span class="co">## 14      14   -0.297566015   0.018720376  51.000000000</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Erik Volz.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
